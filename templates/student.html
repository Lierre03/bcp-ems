<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - School Event Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body,
        #root {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
        }

        /* Sidebar Custom Scrollbar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Firefox */
        .sidebar-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Authentication utilities -->
    <script src="/static/js/auth.js"></script>

    <!-- Components -->
    <script type="text/babel" src="/static/js/components/Sidebar.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/NotificationBell.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/StudentEventCalendar.js?v=3.9"></script>
    <script type="text/babel" src="/static/js/components/StatusBadge.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/SmartBudgetBreakdown.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/ResourceRequirementsChecklist.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/EventTimelineGenerator.js?v=3.1"></script>
    <script type="text/babel" src="/static/js/components/EventFormModal.js?v=3.5"></script>
    <script type="text/babel" src="/static/js/pages/RejectionResolutionPage.js?v=1.0"></script>

    <!-- Main Dashboard Script -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Sidebar = window.Sidebar;
        const NotificationBell = window.NotificationBell;
        const StudentEventCalendar = window.StudentEventCalendar;
        const EventFormModal = window.EventFormModal;
        const RejectionResolutionPage = window.RejectionResolutionPage;

        function StudentDashboard() {
            const [user, setUser] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            // Load last active view from localStorage, default to 'calendar'
            const [activeView, setActiveView] = useState(() => {
                return localStorage.getItem('studentActiveView') || 'calendar';
            });
            const [showEventModal, setShowEventModal] = useState(false);
            const [proposals, setProposals] = useState([]);
            const [proposalsLoading, setProposalsLoading] = useState(false);
            const [resolvingEventId, setResolvingEventId] = useState(null);

            // AI Enhancement States - Same as Admin
            const [aiSuggestions, setAiSuggestions] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            const [budgetData, setBudgetData] = useState(null);
            const [resourceData, setResourceData] = useState(null);
            const [timelineData, setTimelineData] = useState(null);
            const [activeEquipmentTab, setActiveEquipmentTab] = useState('Audio & Visual');
            const [checkedActivities, setCheckedActivities] = useState([]);
            const [checkedResources, setCheckedResources] = useState([]);
            const [modelStatus, setModelStatus] = useState({ ready: false, models: {} });
            const [budgetEstimate, setBudgetEstimate] = useState(null);
            const [lastAIRequest, setLastAIRequest] = useState(null);

            // Pending Feedback Prompt State
            const [showFeedbackPrompt, setShowFeedbackPrompt] = useState(false);
            const [pendingFeedbackCount, setPendingFeedbackCount] = useState(0);

            const [equipmentCategories, setEquipmentCategories] = useState({
                'Audio & Visual': ['Projector', 'Speaker', 'Microphone', 'Screen'],
                'Furniture & Setup': ['Tables', 'Chairs', 'Stage', 'Podium'],
                'Sports & Venue': ['Scoreboard', 'Lighting', 'Camera', 'First Aid Kit']
            });
            const [venueOptions, setVenueOptions] = useState(['Auditorium', 'Gymnasium', 'Main Hall', 'Cafeteria', 'Lab', 'Courtyard', 'Library']);
            const [formData, setFormData] = useState({
                name: '',
                type: 'Academic',
                date: '',
                endDate: '',
                startTime: '09:00',
                endTime: '17:00',
                venue: '',
                equipment: [],
                attendees: '',
                budget: '',
                organizer: '',
                status: 'Pending',
                description: '',
                activities: [],
                additionalResources: []
            });

            useEffect(() => {
                const userJson = localStorage.getItem('user');
                if (userJson) {
                    const userData = JSON.parse(userJson);
                    setUser(userData);
                    // Set default view based on role ONLY if no persisted view
                    if (!localStorage.getItem('studentActiveView')) {
                        if (userData.role_name === 'Student Organization Officer') {
                            setActiveView('proposals');
                        }
                    }
                    // Set organizer name
                    setFormData(prev => ({
                        ...prev,
                        organizer: userData.full_name || userData.username
                    }));
                }

                // Load equipment categories and venues
                loadEquipmentCategories();
                loadVenues();
                loadEquipmentCategories();
                loadVenues();
                checkModelStatus();
                // Auto-check for pending feedback on login
                checkPendingFeedback();

                // Hash Routing Handling
                const handleHashChange = () => {
                    const hash = window.location.hash;
                    if (hash.startsWith('#/resolve-rejection/')) {
                        const eventId = hash.split('/')[2];
                        if (eventId) {
                            setResolvingEventId(eventId);
                            setActiveView('resolve-rejection');
                        }
                    } else if (hash === '#/my-events') {
                        setActiveView('proposals');
                    }
                };

                // Check on mount
                handleHashChange();

                // Listen for changes
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            // Persist active view on change
            useEffect(() => {
                localStorage.setItem('studentActiveView', activeView);
            }, [activeView]);

            const checkModelStatus = async () => {
                try {
                    const response = await fetch('/api/ml/model-status');
                    const data = await response.json();
                    if (data.success) {
                        setModelStatus(data);
                    }
                } catch (error) {
                    console.error('Failed to check model status:', error);
                }
            };

            const loadEquipmentCategories = async () => {
                try {
                    const response = await fetch('/api/ml/equipment-options');
                    const data = await response.json();
                    if (data.success && data.categories) {
                        setEquipmentCategories(data.categories);
                    }
                } catch (error) {
                    console.error('Failed to load equipment options:', error);
                }
            };

            const loadVenues = async () => {
                try {
                    const res = await fetch('/api/venues/');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.venues) {
                            const venueNames = data.venues.map(v => v.name);
                            setVenueOptions(venueNames);

                            // Initialize default venue if not set
                            if (venueNames.length > 0) {
                                setFormData(prev => {
                                    if (!prev.venue) return { ...prev, venue: venueNames[0] };
                                    return prev;
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error('Failed to load venues:', err);
                }
            };

            const checkPendingFeedback = async () => {
                try {
                    const response = await fetch('/api/feedback/pending', { credentials: 'include' });
                    const data = await response.json();
                    if (data.success && data.count > 0) {
                        setPendingFeedbackCount(data.count);
                        // Delay slightly to allow UI to settle
                        setTimeout(() => setShowFeedbackPrompt(true), 1500);
                    }
                } catch (error) {
                    console.error("Error checking pending feedback:", error);
                }
            };

            const loadMyProposals = async () => {
                const userJson = localStorage.getItem('user');
                if (!userJson) return;
                const userData = JSON.parse(userJson);

                setProposalsLoading(true);
                try {
                    // Fetch events created by this user
                    const response = await fetch(`/api/events?requestor_id=${userData.id}`);
                    const data = await response.json();
                    if (data.success) {
                        setProposals(data.events);
                    }
                } catch (error) {
                    console.error('Failed to load proposals', error);
                } finally {
                    setProposalsLoading(false);
                }
            };

            const [filterStatus, setFilterStatus] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            // ... (rest of the code)

            // Expose globally for form submission callback
            window.loadMyProposals = loadMyProposals;

            useEffect(() => {
                if (activeView === 'proposals') {
                    loadMyProposals();
                }
            }, [activeView]);

            // AI Auto-fill function - Updated to match Admin logic
            const handleAutoFill = async () => {
                if (!formData.name.trim()) {
                    alert('Please enter an event name first!');
                    return;
                }

                if (!modelStatus.ready) {
                    const needsTraining = modelStatus.training_samples >= 5;
                    if (needsTraining) {
                        alert('‚ö†Ô∏è AI models need training!\n\nYou have enough training data, but models haven\'t been trained yet.\n\nPlease contact the admin to train the models first.');
                    } else {
                        alert('‚ö†Ô∏è Not enough training data!\n\nAI needs at least 5 validated events to learn from.\n\nUsing basic estimates for now.');
                    }
                }

                setAiLoading(true);
                try {
                    const requestParams = {
                        eventType: formData.type,
                        attendees: parseInt(formData.attendees) || 100,
                        eventName: formData.name || '',
                        duration: 4
                    };

                    setLastAIRequest(requestParams);

                    const response = await fetch('/api/ml/predict-resources', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestParams)
                    });

                    const aiData = await response.json();

                    if (aiData.success) {
                        // Store complete AI data for sidebar suggestions
                        // DO NOT auto-apply to form data to allow user selection
                        setAiSuggestions({
                            success: true,
                            confidence: aiData.confidence,
                            estimatedBudget: aiData.estimatedBudget,
                            budgetBreakdown: aiData.budgetBreakdown, // Store FULL Object for sidebar
                            timeline: aiData.timeline || [],
                            equipment: aiData.equipment || aiData.resources || [],
                            additionalResources: aiData.additionalResources || [],
                            description: aiData.description,
                            suggestedAttendees: aiData.suggestedAttendees,
                            eventType: aiData.eventType
                        });

                        // Only notify success - let user choose from sidebar
                        console.log("AI Analysis complete. Suggestions available in sidebar.");

                    } else {
                        alert('AI analysis failed. Please try again.');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert(`Backend Error: ${error.message}`);
                }
                setAiLoading(false);
            };

            const toggleActivity = (item) => {
                const newActivities = checkedActivities.includes(item)
                    ? checkedActivities.filter(a => a !== item)
                    : [...checkedActivities, item];
                setCheckedActivities(newActivities);
                setFormData(prev => ({ ...prev, activities: newActivities }));
            };

            const toggleAdditionalResource = (item) => {
                const newResources = checkedResources.includes(item)
                    ? checkedResources.filter(r => r !== item)
                    : [...checkedResources, item];
                setCheckedResources(newResources);
                setFormData(prev => ({ ...prev, additionalResources: newResources }));
            };

            const toggleEquipment = (item) => {
                const newEquipment = formData.equipment.includes(item)
                    ? formData.equipment.filter(e => e !== item)
                    : [...formData.equipment, item];
                setFormData(prev => ({ ...prev, equipment: newEquipment }));
            };

            const handleBudgetUpdate = (newBudgetData) => {
                setBudgetData(newBudgetData);
                if (newBudgetData && newBudgetData.totalBudget) {
                    setFormData(prev => ({ ...prev, budget: newBudgetData.totalBudget }));
                }
            };

            const handleEquipmentUpdate = (newEquipment) => {
                setFormData(prev => ({ ...prev, equipment: newEquipment }));
            };

            const handleCreateEventProposal = () => {
                // Reset form data for new event proposal
                setFormData({
                    name: '',
                    type: 'Academic',
                    date: '',
                    endDate: '',
                    startTime: '09:00',
                    endTime: '17:00',
                    venue: '',
                    equipment: [],
                    attendees: '',
                    budget: '',
                    organizer: user?.full_name || user?.username || '',
                    status: 'Pending',
                    description: '',
                    activities: [],
                    additionalResources: []
                });
                setShowEventModal(true);
            };

            const handleSaveEvent = async () => {
                // Validate required fields
                if (!formData.name.trim() || !formData.date) {
                    alert('Event name and date are required');
                    return;
                }

                try {
                    const startDt = `${formData.date} ${formData.startTime}:00`;
                    const endDt = `${formData.endDate || formData.date} ${formData.endTime}:00`;

                    // Filter out empty categories from budget breakdown
                    const filteredBudgetBreakdown = {};
                    if (budgetData && budgetData.breakdown) {
                        Object.entries(budgetData.breakdown).forEach(([category, details]) => {
                            if (category.trim() && details.amount > 0) {
                                filteredBudgetBreakdown[category] = details;
                            }
                        });
                    }

                    const payload = {
                        name: formData.name,
                        event_type: formData.type || 'Academic', // Ensure event_type is never empty
                        start_datetime: startDt,
                        end_datetime: endDt,
                        venue: formData.venue || '',
                        organizer: formData.organizer || (user ? (user.full_name || user.username) : ''),
                        description: formData.description || '',
                        expected_attendees: parseInt(formData.attendees) || 0,
                        budget: parseFloat(formData.budget) || 0,
                        equipment: formData.equipment || [],
                        activities: formData.activities || [], // Fallback if no detailed timeline
                        timeline: (timelineData && timelineData.timeline && timelineData.timeline.length > 0) ? timelineData.timeline : [],
                        budget_breakdown: filteredBudgetBreakdown,
                        additional_resources: formData.additionalResources || []
                    };

                    console.log('Submitting payload:', payload);

                    const response = await fetch('/api/events', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert('Event proposal submitted successfully! It will be reviewed by the admin.');
                        setShowEventModal(false);
                        // Reload data
                        if (activeView === 'proposals' && window.loadMyProposals) {
                            window.loadMyProposals();
                        } else if (typeof loadMyRegistrations === 'function') {
                            loadMyRegistrations();
                        }
                    } else {
                        console.error('Server error:', data);
                        alert(data.error || 'Failed to submit event proposal');
                    }
                } catch (error) {
                    console.error('Error submitting event:', error);
                    alert('Failed to submit event proposal. Please try again.');
                }
            };





            // Helper function to convert 24-hour time to 12-hour AM/PM format
            const formatTime12Hour = (time24) => {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            };

            const handleLogout = async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    localStorage.removeItem('user');
                    localStorage.removeItem('studentActiveView'); // Clear active view preference
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            };

            const loadMyRegistrations = async () => {
                try {
                    const response = await fetch('/api/registration/my-registrations', {
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        const registrations = data.registrations;
                        const registeredCount = registrations.filter(r => r.registration_status === 'Registered').length;
                        const waitlistCount = registrations.filter(r => r.registration_status === 'Waitlisted').length;
                        const upcomingCount = registrations.filter(r => new Date(r.start_datetime) > new Date()).length;

                        document.getElementById('registeredCount').textContent = registeredCount;
                        document.getElementById('waitlistCount').textContent = waitlistCount;
                        document.getElementById('upcomingCount').textContent = upcomingCount;

                        const container = document.getElementById('registrationsContainer');
                        const loading = document.getElementById('registrationsLoading');
                        const noRegistrations = document.getElementById('noRegistrations');

                        loading.classList.add('hidden');

                        if (registrations.length === 0) {
                            noRegistrations.classList.remove('hidden');
                            return;
                        }

                        container.classList.remove('hidden');
                        container.innerHTML = '';

                        registrations.forEach(reg => {
                            const statusColor = reg.registration_status === 'Registered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                            const statusText = reg.registration_status === 'Registered' ? '‚úÖ Confirmed' : '‚è≥ Waitlisted';

                            // Check for past event
                            const eventEndDate = new Date(reg.start_datetime); // Using start time as proxy if end time not available
                            const isPast = eventEndDate < new Date();

                            // Apply styles
                            const cardOpacity = isPast ? 'bg-gray-50 opacity-75' : 'bg-white';
                            const grayscale = isPast ? 'grayscale' : '';
                            const textColor = isPast ? 'text-gray-500' : 'text-gray-900';
                            const dateColor = isPast ? 'text-gray-400' : 'text-gray-600';

                            const card = document.createElement('div');
                            card.className = `border border-gray-200 rounded-lg p-6 hover:shadow-md transition ${cardOpacity}`;
                            card.innerHTML = `
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="font-semibold ${textColor} mb-1 ${grayscale}">${reg.name}</h3>
                                        <p class="text-sm ${dateColor} mb-2 ${grayscale}">${new Date(reg.start_datetime).toLocaleDateString()} ‚Ä¢ ${reg.venue} ‚Ä¢ ${new Date(reg.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                        <div class="flex items-center gap-4 text-sm">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${isPast ? 'bg-gray-200 text-gray-500' : statusColor}">
                                                ${isPast && reg.registration_status === 'Registered' ? 'Completed' : statusText}
                                            </span>
                                            <span class="text-gray-500">Reg ID: #${reg.id}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${isPast ?
                                    '<span class="text-xs font-medium text-gray-400 border border-gray-200 px-2 py-1 rounded bg-gray-100">Event Ended</span>' :
                                    (reg.registration_status === 'Registered' ?
                                        '<button class="px-3 py-1 border border-red-300 text-red-700 rounded-lg text-sm hover:bg-red-50 transition cancel-btn" data-event-id="' + reg.event_id + '">Cancel</button>' :
                                        '<button class="px-3 py-1 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50 transition">Leave Waitlist</button>'
                                    )
                                }
                                    </div>
                                </div>

                                <!-- QR Code Section for Confirmed Registrations -->
                                ${reg.registration_status === 'Registered' ? `
                                <div class="border-t border-gray-100 pt-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="text-sm font-medium text-gray-900">Attendance QR Code</h4>
                                        <button class="text-blue-600 hover:text-blue-800 text-sm font-medium qr-btn" data-reg-id="${reg.id}">
                                            Show QR Code
                                        </button>
                                    </div>
                                    <div class="qr-container-${reg.id} hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-sm text-gray-600">Show this QR code at the event entrance</span>
                                            <div class="flex gap-2">
                                                <button class="text-green-600 hover:text-green-800 text-xs qr-download-btn" data-reg-id="${reg.id}">üì• Download</button>
                                                <button class="text-blue-600 hover:text-blue-800 text-xs qr-close-btn" data-reg-id="${reg.id}">‚úï Close</button>
                                            </div>
                                        </div>
                                        <div class="qr-image-${reg.id} flex justify-center">
                                            <div class="animate-pulse bg-gray-200 h-32 w-32 rounded-lg flex items-center justify-center">
                                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M8 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M8 12h4.01M8 15h4.01M8 21h4.01" />
                                                </svg>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 text-center mt-2">Loading QR code...</p>
                                    </div>
                                </div>
                                ` : ''}
                            `;

                            container.appendChild(card);
                        });

                        // Add event listeners for cancel buttons
                        document.querySelectorAll('.cancel-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const eventId = e.target.dataset.eventId;
                                if (confirm('Are you sure you want to cancel this registration?')) {
                                    try {
                                        const cancelResponse = await fetch(`/api/registration/unregister/${eventId}`, {
                                            method: 'POST',
                                            credentials: 'include'
                                        });

                                        const cancelData = await cancelResponse.json();

                                        if (cancelResponse.ok && cancelData.success) {
                                            alert('Registration cancelled successfully!');
                                            loadMyRegistrations(); // Reload the list
                                        } else {
                                            alert(cancelData.error || 'Failed to cancel registration');
                                        }
                                    } catch (error) {
                                        alert('Failed to cancel registration. Please try again.');
                                    }
                                }
                            });
                        });

                        // Add event listeners for QR code buttons
                        document.querySelectorAll('.qr-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const regId = e.target.dataset.regId;
                                const container = document.querySelector(`.qr-container-${regId}`);
                                const imageContainer = document.querySelector(`.qr-image-${regId}`);
                                const loadingText = container.querySelector('p'); // Select the loading text

                                if (container.classList.contains('hidden')) {
                                    // Show QR container and load QR code
                                    container.classList.remove('hidden');

                                    // Reset state
                                    imageContainer.innerHTML = `
                            <div class="animate-pulse bg-gray-200 h-32 w-32 rounded-lg flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M8 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M8 12h4.01M8 15h4.01M8 21h4.01" />
                                </svg>
                            </div>
                        `;
                                    if (loadingText) loadingText.classList.remove('hidden');

                                    try {
                                        const response = await fetch(`/api/attendance/generate-qr/${regId}`, {
                                            credentials: 'include'
                                        });

                                        const data = await response.json();

                                        if (response.ok && data.success) {
                                            imageContainer.innerHTML = `
                                    <img src="${data.qr_image}" alt="QR Code" class="w-32 h-32 border border-gray-300 rounded-lg" />
                                `;
                                            if (loadingText) loadingText.classList.add('hidden');
                                        } else {
                                            imageContainer.innerHTML = `
                                    <div class="w-32 h-32 bg-red-50 border border-red-200 rounded-lg flex items-center justify-center">
                                        <span class="text-red-600 text-xs text-center">Failed to load QR code</span>
                                    </div>
                                `;
                                            if (loadingText) loadingText.classList.add('hidden');
                                        }
                                    } catch (error) {
                                        console.error('QR code loading error:', error);
                                        imageContainer.innerHTML = `
                                <div class="w-32 h-32 bg-red-50 border border-red-200 rounded-lg flex items-center justify-center">
                                    <span class="text-red-600 text-xs text-center">Network error</span>
                                </div>
                            `;
                                        if (loadingText) loadingText.classList.add('hidden');
                                    }
                                } else {
                                    // Hide QR container
                                    container.classList.add('hidden');
                                }
                            });
                        });

                        // Add event listeners for QR download buttons
                        document.querySelectorAll('.qr-download-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const regId = e.target.dataset.regId;
                                const img = document.querySelector(`.qr-image-${regId} img`);
                                if (img) {
                                    // Create download link
                                    const link = document.createElement('a');
                                    link.href = img.src;
                                    link.download = `event-qr-${regId}.png`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                }
                            });
                        });

                        // Add event listeners for QR close buttons
                        document.querySelectorAll('.qr-close-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const regId = e.target.dataset.regId;
                                const container = document.querySelector(`.qr-container-${regId}`);
                                container.classList.add('hidden');
                            });
                        });

                    } else {
                        console.error('Failed to load registrations:', data.error);
                    }
                } catch (error) {
                    console.error('Error loading registrations:', error);
                }
            };

            // Menu items differ based on role
            const menuItems = user?.role_name === 'Student Organization Officer' ? [
                {
                    items: [
                        {
                            id: 'proposals',
                            label: 'Event Proposals',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        },
                        {
                            id: 'calendar',
                            label: 'Event Calendar',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        },
                        {
                            id: 'registrations',
                            label: 'My Registrations',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        },
                        {
                            id: 'attendance',
                            label: 'Attendance',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        },
                        {
                            id: 'feedback',
                            label: 'My Feedback',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        }
                    ]
                }
            ] : [
                {
                    items: [
                        {
                            id: 'calendar',
                            label: 'Event Calendar',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        },
                        {
                            id: 'registrations',
                            label: 'My Registrations',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        },
                        {
                            id: 'attendance',
                            label: 'Attendance',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        },
                        {
                            id: 'feedback',
                            label: 'My Feedback',
                            icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                        }
                    ]
                }
            ];

            const loadMyFeedback = async () => {
                try {
                    // Load pending feedback
                    const pendingResponse = await fetch('/api/feedback/pending', {
                        credentials: 'include'
                    });

                    const pendingData = await pendingResponse.json();

                    // Load feedback history
                    const historyResponse = await fetch('/api/feedback/my-feedback', {
                        credentials: 'include'
                    });

                    const historyData = await historyResponse.json();

                    // Update pending feedback section
                    const pendingContainer = document.getElementById('pendingFeedbackContainer');
                    const historyContainer = document.getElementById('feedbackHistoryContainer');
                    const noFeedback = document.getElementById('noFeedback');

                    pendingContainer.innerHTML = '';
                    historyContainer.innerHTML = '';

                    // Show pending feedback forms
                    if (pendingData.success && pendingData.pending_events && pendingData.pending_events.length > 0) {
                        const pendingHeader = document.createElement('div');
                        pendingHeader.innerHTML = `
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                <h3 class="text-lg font-semibold text-gray-900">Pending Feedback</h3>
                                <span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">
                                    ${pendingData.pending_events.length} form${pendingData.pending_events.length > 1 ? 's' : ''} to complete
                                </span>
                            </div>
                        `;
                        pendingContainer.appendChild(pendingHeader);

                        // Mockup-Matched Professional Evaluation
                        pendingData.pending_events.forEach(event => {
                            const feedbackForm = document.createElement('div');
                            feedbackForm.className = 'bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden mb-8 font-sans';
                            feedbackForm.innerHTML = `
                                <!-- Header -->
                                <div class="bg-slate-800 px-6 py-4 flex justify-between items-center text-white border-b border-slate-700">
                                    <div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs font-bold text-blue-200 border border-blue-400/30 px-1.5 py-0.5 rounded uppercase tracking-wider">Event Feedback</span>
                                            <h4 class="text-lg font-semibold tracking-tight text-white">${event.name}</h4>
                                        </div>
                                        <div class="flex gap-3 text-xs text-slate-400 mt-1 pl-[108px]">
                                            <span class="border-r border-slate-600 pr-3">Date: ${new Date(event.start_datetime).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                            <span>Location: ${event.venue}</span>
                                        </div>
                                    </div>
                                </div>

                                <form class="feedback-form-${event.id}">
                                    <!-- 3-Column Grid -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-200 bg-white">
                                        
                                        <!-- COL 1: LOGISTICS -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">LOGISTICS</h5>
                                            
                                            <div class="space-y-6">
                                                <!-- Registration -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Registration Process</label>
                                                        <span class="text-xs font-bold text-slate-400 reg-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="reg-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="reg-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>

                                                <!-- Organization (Timeliness) -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Timeliness & Organization</label>
                                                        <span class="text-xs font-bold text-slate-400 org-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="org-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="org-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- COL 2: CONTENT -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">CONTENT</h5>
                                            
                                            <div class="space-y-6">
                                                <!-- Speaker -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Keynote Speakers</label>
                                                        <span class="text-xs font-bold text-slate-400 speaker-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="speaker-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="speaker-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>

                                                <!-- Content Relevance -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Relevance of Topics</label>
                                                        <span class="text-xs font-bold text-slate-400 content-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="content-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="content-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- COL 3: FACILITIES -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">FACILITIES</h5>
                                            
                                            <div class="space-y-6">
                                                <!-- Venue -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Venue Comfort</label>
                                                        <span class="text-xs font-bold text-slate-400 venue-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="venue-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="venue-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>

                                                <!-- Activities / Amenities -->
                                                <div>
                                                    <div class="flex justify-between mb-1">
                                                        <label class="text-sm font-medium text-slate-700">Overall Activities</label>
                                                        <span class="text-xs font-bold text-slate-400 activities-val-${event.id}"></span>
                                                    </div>
                                                    <div class="flex gap-1" id="activities-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="activities-star-${event.id} text-slate-300 hover:text-slate-500 transition-colors" data-rating="${n}"><svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer: OVERALL SATISFACTION & NPS -->
                                    <div class="bg-gray-200/80 border-t border-gray-300 p-6">
                                        <!-- 3-Column Grid -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                                            
                                            <!-- Col 1: Overall Rating -->
                                            <div class="flex flex-col justify-center border-r border-gray-300 pr-4">
                                                <div class="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Overall Rating</div>
                                                <div class="flex items-center gap-4">
                                                    <div class="flex gap-1" id="overall-stars-${event.id}">
                                                        ${[1, 2, 3, 4, 5].map(n => `<button type="button" class="overall-star-${event.id} text-slate-400 hover:text-slate-600 transition-transform active:scale-95" data-rating="${n}"><svg class="w-8 h-8 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>`).join('')}
                                                    </div>
                                                    <div class="text-3xl font-bold text-slate-700 overall-display-${event.id}">0.0</div>
                                                </div>
                                            </div>

                                            <!-- Col 2: NPS -->
                                            <div class="flex flex-col justify-center border-r border-gray-300 pr-4 pl-4">
                                                <div class="flex justify-between items-end mb-2">
                                                    <div>
                                                        <div class="text-xs font-bold text-slate-800 uppercase">Recommendation Score</div>
                                                        <div class="text-[10px] text-slate-500">Recommend us?</div>
                                                    </div>
                                                    <div class="nps-display-${event.id} bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded hidden">
                                                        <span class="val"></span>
                                                    </div>
                                                </div>
                                                <div class="flex justify-between gap-1 mb-1">
                                                    ${[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => `
                                                        <button type="button" class="nps-btn-${event.id} h-7 w-full rounded border border-slate-300 bg-white text-slate-500 text-[10px] font-bold hover:border-blue-500 hover:text-blue-600 transition-all focus:outline-none" data-val="${n}">${n}</button>
                                                    `).join('')}
                                                </div>
                                                <div class="flex justify-between text-[8px] font-bold text-slate-400 uppercase">
                                                    <span>Not Likely</span>
                                                    <span>Very Likely</span>
                                                </div>
                                            </div>

                                            <!-- Col 3: Comments -->
                                            <div class="flex flex-col pl-4">
                                                <textarea class="comments-${event.id} w-full h-full min-h-[80px] p-2 bg-white border border-gray-300 rounded text-xs focus:outline-none focus:border-blue-500 shadow-inner resize-none" placeholder="Additional Comments (Optional)"></textarea>
                                                <!-- Hidden Logic Fields -->
                                                <textarea class="hidden takeaways-${event.id}"></textarea>
                                                <input type="checkbox" class="hidden future-check-${event.id}">
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-300">
                                             <button type="button" class="skip-btn-${event.id} px-4 py-2 text-xs font-bold text-slate-500 uppercase hover:bg-gray-300 rounded transition-colors">Cancel</button>
                                             <button type="submit" disabled class="submit-feedback-btn-${event.id} px-6 py-2 bg-slate-700 text-white text-xs font-bold uppercase rounded hover:bg-slate-800 shadow-md transition-all disabled:opacity-50 disabled:shadow-none">Submit Feedback</button>
                                        </div>
                                    </div>
                                </form>
                            `;
                            pendingContainer.appendChild(feedbackForm);
                        });

                        // Logic
                        pendingData.pending_events.forEach(event => {
                            const form = document.querySelector(`.feedback-form-${event.id}`);

                            // State
                            let ratings = {
                                overall: 0,
                                venue: 0,
                                activities: 0,
                                org: 0,
                                speaker: 0,
                                content: 0,
                                reg: 0,
                                nps: null
                            };

                            const submitBtn = document.querySelector(`.submit-feedback-btn-${event.id}`);
                            const overallDisplay = document.querySelector(`.overall-display-${event.id}`);

                            const checkValidity = () => {
                                if (ratings.overall > 0) submitBtn.disabled = false;
                            };

                            // Star Logic
                            const setupStars = (name, selector) => {
                                const buttons = document.querySelectorAll(`.${selector}-${event.id}`);
                                const valDisplay = document.querySelector(`.${name === 'overall' ? 'none' : selector.split('-')[0] + '-val-' + event.id}`);

                                buttons.forEach((btn, idx) => {
                                    const rating = parseInt(btn.dataset.rating);
                                    btn.addEventListener('mouseenter', () => renderStars(buttons, rating, name === 'overall'));
                                    btn.addEventListener('mouseleave', () => renderStars(buttons, ratings[name], name === 'overall'));
                                    btn.addEventListener('click', () => {
                                        ratings[name] = rating;
                                        renderStars(buttons, rating, name === 'overall');
                                        if (valDisplay) {
                                            valDisplay.textContent = rating + '.0/5';
                                        }
                                        if (name === 'overall' && overallDisplay) {
                                            overallDisplay.textContent = rating + '.0';
                                        }
                                        checkValidity();
                                    });
                                });
                            };

                            const renderStars = (buttons, activeRating, isOverall) => {
                                buttons.forEach((btn, idx) => {
                                    const rating = idx + 1;
                                    const isActive = rating <= activeRating;
                                    if (isActive) {
                                        btn.classList.add('text-blue-600');
                                        btn.classList.remove('text-slate-300', 'text-slate-400');
                                    } else {
                                        btn.classList.remove('text-slate-500');
                                        btn.classList.add(isOverall ? 'text-slate-400' : 'text-slate-300');
                                    }
                                });
                            };

                            // NPS Button Logic
                            const npsButtons = document.querySelectorAll(`.nps-btn-${event.id}`);
                            const npsDisplay = document.querySelector(`.nps-display-${event.id}`);
                            const npsValSpan = npsDisplay ? npsDisplay.querySelector('.val') : null;

                            npsButtons.forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const val = parseInt(btn.dataset.val);
                                    ratings.nps = val;

                                    // Update UI
                                    npsButtons.forEach(b => {
                                        const bVal = parseInt(b.dataset.val);
                                        // Reset classes
                                        b.className = `nps-btn-${event.id} h-7 w-full rounded border font-bold text-[10px] transition-all focus:outline-none`;

                                        if (bVal === val) {
                                            // Active State
                                            b.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
                                        } else {
                                            // Inactive State
                                            b.classList.add('bg-white', 'text-slate-500', 'border-slate-300', 'hover:border-blue-500', 'hover:text-blue-600');
                                        }
                                    });

                                    if (npsDisplay) npsDisplay.classList.remove('hidden');
                                    if (npsValSpan) npsValSpan.textContent = val;
                                });
                            });

                            // Setup 
                            setupStars('overall', 'overall-star');
                            setupStars('venue', 'venue-star');
                            setupStars('activities', 'activities-star');
                            setupStars('org', 'org-star');
                            setupStars('speaker', 'speaker-star');
                            setupStars('content', 'content-star');
                            setupStars('reg', 'reg-star');

                            // Submit
                            form.addEventListener('submit', async (e) => {
                                e.preventDefault();

                                if (ratings.overall === 0) {
                                    alert('Overall Rating Required');
                                    return;
                                }

                                submitBtn.disabled = true;
                                submitBtn.innerText = 'Submitting...';

                                const payload = {
                                    overall_rating: ratings.overall,
                                    venue_rating: ratings.venue || null,
                                    activities_rating: ratings.activities || null,
                                    organization_rating: ratings.org || null,
                                    registration_process: ratings.reg || null,
                                    speaker_effectiveness: ratings.speaker || null,
                                    content_relevance: ratings.content || null,
                                    net_promoter_score: ratings.nps,
                                    key_takeaways: 'Generated via Mockup UI',
                                    comments: document.querySelector(`.comments-${event.id}`).value,
                                    future_interest: false
                                };

                                try {
                                    const res = await fetch(`/api/feedback/submit/${event.id}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    });
                                    if (res.ok) {
                                        submitBtn.innerText = 'Submitted';
                                        setTimeout(() => loadMyFeedback(), 500);
                                    } else {
                                        submitBtn.disabled = false;
                                        alert('Failed');
                                    }
                                } catch (e) {
                                    console.error(e);
                                    submitBtn.disabled = false;
                                }
                            });
                            // Skip feedback
                            document.querySelector(`.skip-btn-${event.id}`).addEventListener('click', () => {
                                if (confirm('Are you sure you want to skip this feedback? You can return to it later.')) {
                                    const feedbackForm = document.querySelector(`.feedback-form-${event.id}`).closest('.mb-8');
                                    if (feedbackForm) feedbackForm.remove();
                                    if (document.querySelectorAll('[class*="feedback-form-"]').length === 0) loadMyFeedback();
                                }
                            });
                        });
                    }

                    // Show feedback history
                    if (historyData.success && historyData.feedback && historyData.feedback.length > 0) {
                        const historyHeader = document.createElement('div');
                        historyHeader.innerHTML = `
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                <h3 class="text-lg font-semibold text-gray-900">Feedback History</h3>
                            </div>
                        `;
                        historyContainer.appendChild(historyHeader);

                        historyData.feedback.forEach(feedback => {
                            const feedbackCard = document.createElement('div');
                            feedbackCard.className = 'border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition';

                            // Define categories to show
                            const categories = [
                                { label: 'Registration', key: 'registration_process' },
                                { label: 'Organization', key: 'organization_rating' },
                                { label: 'Speakers', key: 'speaker_effectiveness' },
                                { label: 'Content', key: 'content_relevance' },
                                { label: 'Venue', key: 'venue_rating' },
                                { label: 'Activities', key: 'activities_rating' }
                            ];

                            feedbackCard.innerHTML = `
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 mb-1">${feedback.event_name}</h4>
                                        <p class="text-xs text-gray-500 mb-3 uppercase tracking-wide">${new Date(feedback.created_at).toLocaleDateString()} ‚Ä¢ Overall Rating</p>
                                        
                                        <!-- Overall & NPS -->
                                        <div class="flex items-center gap-4 mb-4">
                                            <div class="flex items-center gap-2">
                                                <div class="flex">
                                                    ${[1, 2, 3, 4, 5].map(star => `
                                                        <span class="text-yellow-400 text-2xl drop-shadow-sm">${star <= feedback.overall_rating ? '‚òÖ' : '‚òÜ'}</span>
                                                    `).join('')}
                                                </div>
                                                <span class="text-xl font-bold text-gray-700">${feedback.overall_rating}.0</span>
                                            </div>
                                            ${feedback.net_promoter_score !== null ? `
                                            <div class="bg-blue-50 px-3 py-1 rounded border border-blue-100 flex flex-col items-center">
                                                <span class="text-[10px] uppercase font-bold text-blue-400">NPS</span>
                                                <span class="font-bold text-blue-700">${feedback.net_promoter_score}</span>
                                            </div>` : ''}
                                        </div>

                                        <!-- Detailed Categories Grid -->
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-y-3 gap-x-6 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            ${categories.map(cat => feedback[cat.key] ? `
                                                <div class="flex flex-col">
                                                    <span class="text-[10px] uppercase font-bold text-slate-400 mb-0.5">${cat.label}</span>
                                                    <div class="flex items-center gap-1">
                                                        <div class="flex">
                                                            ${[1, 2, 3, 4, 5].map(star => `
                                                                <span class="text-yellow-400 text-sm">${star <= feedback[cat.key] ? '‚òÖ' : '‚òÜ'}</span>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : '').join('')}
                                        </div>
                                    </div>

                                    <div class="flex flex-col items-end gap-2 ml-4">
                                        ${feedback.can_edit ? `
                                            <span class="text-[10px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full mb-1 border border-green-200">EDITABLE</span>
                                            <button onclick='enableEditing(${JSON.stringify(feedback).replace(/'/g, "&#39;")})' class="text-xs font-medium bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded hover:bg-blue-50 transition shadow-sm">Edit Feedback</button>
                                        ` : '<span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">LOCKED</span>'}
                                    </div>
                                </div>
                                ${feedback.comments ? `
                                <div class="mt-3 text-sm text-gray-600 border-t border-gray-100 pt-3">
                                    <span class="text-xs font-bold text-slate-400 uppercase">Comments</span>
                                    <p class="mt-1">"${feedback.comments}"</p>
                                </div>` : ''}
                            `;
                            feedbackCard.id = `feedback-card-${feedback.event_id}`;
                            historyContainer.appendChild(feedbackCard);
                        });
                    }

                    // Enable Editing Function
                    window.enableEditing = (feedback) => {
                        const card = document.getElementById(`feedback-card-${feedback.event_id}`);
                        if (!card) return;

                        // Helper for criteria rows
                        const renderCriteriaRow = (label, key, val) => `
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-sm font-medium text-slate-700">${label}</label>
                                    <span class="text-xs font-bold text-slate-400 ${key}-val-${feedback.event_id}">${val + '.0'}</span>
                                </div>
                                <div class="flex gap-1">
                                    ${[1, 2, 3, 4, 5].map(n => `
                                        <button type="button" 
                                            class="criteria-star-${key}-${feedback.event_id} transition-colors ${n <= val ? 'text-blue-600' : 'text-slate-300'} hover:text-slate-500" 
                                            data-rating="${n}"
                                            data-key="${key}"
                                            onclick="selectCriteria(this, '${key}', ${feedback.event_id})">
                                            <svg class="w-6 h-6 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="${key}-${feedback.event_id}" value="${val}">
                            </div>
                        `;

                        card.innerHTML = `
                            <div class="bg-gray-200/80 border border-gray-300 rounded-lg p-0 mb-4 overflow-hidden">
                                <form onsubmit="submitEdit(event, ${feedback.event_id})">
                                    <div class="bg-white p-4 border-b border-gray-200 flex justify-between items-center">
                                        <h3 class="font-bold text-gray-900">Edit Feedback: ${feedback.event_name}</h3>
                                        <button type="button" onclick="loadMyFeedback()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                                    </div>

                                    <!-- Criteria Section (3 Cols) -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-0 divide-y md:divide-y-0 md:divide-x divide-gray-300 border-b border-gray-300">
                                        <!-- LOGISTICS -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-300 pb-2">LOGISTICS</h5>
                                            <div class="space-y-6">
                                                ${renderCriteriaRow('Registration Process', 'reg', feedback.registration_process || 0)}
                                                ${renderCriteriaRow('Timeliness & Organization', 'org', feedback.organization_rating || 0)}
                                            </div>
                                        </div>
                                        <!-- CONTENT -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-300 pb-2">CONTENT</h5>
                                            <div class="space-y-6">
                                                ${renderCriteriaRow('Keynote Speakers', 'speaker', feedback.speaker_effectiveness || 0)}
                                                ${renderCriteriaRow('Relevance of Topics', 'content', feedback.content_relevance || 0)}
                                            </div>
                                        </div>
                                        <!-- FACILITIES -->
                                        <div class="p-5">
                                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-gray-300 pb-2">FACILITIES</h5>
                                            <div class="space-y-6">
                                                ${renderCriteriaRow('Venue Comfort', 'venue', feedback.venue_rating || 0)}
                                                ${renderCriteriaRow('Overall Activities', 'activities', feedback.activities_rating || 0)}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Footer (Overall & NPS & Comments) -->
                                    <div class="p-6">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                                            
                                            <!-- Col 1: Overall Rating -->
                                            <div class="flex flex-col justify-center border-r border-gray-300 pr-4">
                                                <div class="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Overall Rating</div>
                                                <div class="flex items-center gap-4">
                                                    <div class="flex gap-1">
                                                        ${[1, 2, 3, 4, 5].map(star => `
                                                            <button type="button" 
                                                                class="text-slate-400 hover:text-slate-600 transition-transform active:scale-95 text-3xl focus:outline-none star-rating-${feedback.event_id}" 
                                                                data-value="${star}"
                                                                onclick="selectStar(this, ${feedback.event_id})">
                                                                <svg class="w-8 h-8 drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                                            </button>
                                                        `).join('')}
                                                    </div>
                                                    <div class="text-3xl font-bold text-slate-700 overall-display-${feedback.event_id}">${feedback.overall_rating}.0</div>
                                                </div>
                                                <input type="hidden" id="overall-${feedback.event_id}" value="${feedback.overall_rating}">
                                            </div>

                                            <!-- Col 2: NPS -->
                                            <div class="flex flex-col justify-center border-r border-gray-300 pr-4 pl-4">
                                                <div class="flex justify-between items-end mb-2">
                                                    <div>
                                                        <div class="text-xs font-bold text-slate-800 uppercase">Recommendation Score</div>
                                                        <div class="text-[10px] text-slate-500">Recommend us?</div>
                                                    </div>
                                                    <div class="nps-display-${feedback.event_id} ${feedback.net_promoter_score !== null ? '' : 'hidden'} bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded">
                                                        <span class="val">${feedback.net_promoter_score !== null ? feedback.net_promoter_score : ''}</span>
                                                    </div>
                                                </div>
                                                <div class="flex justify-between gap-1 mb-1">
                                                    ${[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => `
                                                        <button type="button" 
                                                            class="nps-btn-${feedback.event_id} h-7 w-full rounded border border-slate-300 text-[10px] font-bold transition-all focus:outline-none ${feedback.net_promoter_score === n ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-500 hover:border-blue-500 hover:text-blue-600'}" 
                                                            data-val="${n}"
                                                            onclick="selectNPS(this, ${feedback.event_id})">${n}</button>
                                                    `).join('')}
                                                </div>
                                                <div class="flex justify-between text-[8px] font-bold text-slate-400 uppercase">
                                                    <span>Not Likely</span>
                                                    <span>Very Likely</span>
                                                </div>
                                                <input type="hidden" id="nps-${feedback.event_id}" value="${feedback.net_promoter_score !== null ? feedback.net_promoter_score : ''}">
                                            </div>

                                            <!-- Col 3: Comments -->
                                            <div class="flex flex-col pl-4">
                                                <textarea 
                                                    class="comments-${feedback.event_id} w-full h-full min-h-[80px] p-2 bg-white border border-gray-300 rounded text-xs focus:outline-none focus:border-blue-500 shadow-inner resize-none" 
                                                    placeholder="Additional Comments (Optional)"
                                                >${feedback.comments || ''}</textarea>
                                            </div>
                                        </div>

                                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-300">
                                            <button type="button" onclick="loadMyFeedback()" class="px-4 py-2 text-xs font-bold text-slate-500 uppercase hover:bg-gray-300 rounded transition-colors">Cancel</button>
                                            <button 
                                                type="submit"
                                                class="submit-edit-${feedback.event_id} px-6 py-2 bg-slate-700 text-white text-xs font-bold uppercase rounded hover:bg-slate-800 shadow-md transition-all">
                                                Update Feedback
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        `;

                        // Initialize stars color (Overall)
                        const stars = card.querySelectorAll(`.star-rating-${feedback.event_id}`);
                        stars.forEach(s => {
                            if (parseInt(s.dataset.value) <= feedback.overall_rating) {
                                s.classList.add('text-blue-600');
                                s.classList.remove('text-slate-400');
                            } else {
                                s.classList.remove('text-blue-600');
                                s.classList.add('text-slate-400');
                            }
                        });
                    };

                    // Criteria Selection Helper
                    window.selectCriteria = (btn, key, eventId) => {
                        const val = parseInt(btn.dataset.rating);
                        document.getElementById(`${key}-${eventId}`).value = val;
                        document.querySelector(`.${key}-val-${eventId}`).textContent = val + '.0';

                        const stars = document.querySelectorAll(`.criteria-star-${key}-${eventId}`);
                        stars.forEach(s => {
                            if (parseInt(s.dataset.rating) <= val) {
                                s.classList.add('text-blue-600');
                                s.classList.remove('text-slate-300');
                            } else {
                                s.classList.remove('text-blue-600');
                                s.classList.add('text-slate-300');
                            }
                        });
                    };

                    // Star Selection Helper (Overall)
                    window.selectStar = (btn, eventId) => {
                        const val = parseInt(btn.dataset.value);
                        document.getElementById(`overall-${eventId}`).value = val;
                        document.querySelector(`.overall-display-${eventId}`).textContent = val + '.0';

                        const stars = document.querySelectorAll(`.star-rating-${eventId}`);
                        stars.forEach(s => {
                            if (parseInt(s.dataset.value) <= val) {
                                s.classList.add('text-blue-600');
                                s.classList.remove('text-slate-400');
                            } else {
                                s.classList.remove('text-blue-600');
                                s.classList.add('text-slate-400');
                            }
                        });
                    };

                    // NPS Selection Helper
                    window.selectNPS = (btn, eventId) => {
                        const val = parseInt(btn.dataset.val);
                        document.getElementById(`nps-${eventId}`).value = val;

                        // Update display badge
                        const display = document.querySelector(`.nps-display-${eventId}`);
                        display.classList.remove('hidden');
                        display.querySelector('.val').textContent = val;

                        // Update buttons
                        const buttons = document.querySelectorAll(`.nps-btn-${eventId}`);
                        buttons.forEach(b => {
                            const bVal = parseInt(b.dataset.val);
                            if (bVal === val) {
                                b.className = `nps-btn-${eventId} h-7 w-full rounded border font-bold text-[10px] transition-all focus:outline-none bg-blue-600 text-white border-blue-600 shadow-md`;
                            } else {
                                b.className = `nps-btn-${eventId} h-7 w-full rounded border border-slate-300 bg-white text-slate-500 text-[10px] font-bold hover:border-blue-500 hover:text-blue-600 transition-all focus:outline-none`;
                            }
                        });
                    };

                    // Submit Edit Function
                    window.submitEdit = async (e, eventId) => {
                        if (e) e.preventDefault();
                        const submitBtn = document.querySelector(`.submit-edit-${eventId}`);

                        const overall = document.getElementById(`overall-${eventId}`).value;
                        const nps = document.getElementById(`nps-${eventId}`).value;
                        const comments = document.querySelector(`.comments-${eventId}`).value;

                        // Criteria
                        const venue = document.getElementById(`venue-${eventId}`).value;
                        const activities = document.getElementById(`activities-${eventId}`).value;
                        const org = document.getElementById(`org-${eventId}`).value;
                        const reg = document.getElementById(`reg-${eventId}`).value;
                        const speaker = document.getElementById(`speaker-${eventId}`).value;
                        const content = document.getElementById(`content-${eventId}`).value;

                        if (!overall || parseInt(overall) === 0) {
                            alert('Overall Rating Required');
                            return;
                        }

                        submitBtn.disabled = true;
                        submitBtn.innerText = 'Updating...';

                        try {
                            const payload = {
                                overall_rating: parseInt(overall),
                                comments: comments,
                                net_promoter_score: nps ? parseInt(nps) : null,
                                venue_rating: venue ? parseInt(venue) : null,
                                activities_rating: activities ? parseInt(activities) : null,
                                organization_rating: org ? parseInt(org) : null,
                                registration_process: reg ? parseInt(reg) : null,
                                speaker_effectiveness: speaker ? parseInt(speaker) : null,
                                content_relevance: content ? parseInt(content) : null
                            };

                            const res = await fetch(`/api/feedback/submit/${eventId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (res.ok) {
                                submitBtn.innerText = 'Updated';
                                setTimeout(() => loadMyFeedback(), 500);
                            } else {
                                const err = await res.json();
                                alert(err.error || 'Failed to update');
                                submitBtn.disabled = false;
                                submitBtn.innerText = 'Update Feedback';
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Network error');
                            submitBtn.disabled = false;
                        }
                    };

                    // Show no feedback message if nothing to show
                    if ((!pendingData.success || !pendingData.pending_events || pendingData.pending_events.length === 0) &&
                        (!historyData.success || !historyData.feedback || historyData.feedback.length === 0)) {
                        noFeedback.classList.remove('hidden');
                    } else {
                        noFeedback.classList.add('hidden');
                    }

                } catch (error) {
                    console.error('Error loading feedback:', error);
                }
            };

            const loadMyAttendance = async () => {
                try {
                    const response = await fetch('/api/attendance/my-history', {
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        const attendanceRecords = data.attendance_history;
                        const container = document.getElementById('attendanceContainer');
                        const loading = document.getElementById('attendanceLoading');
                        const noAttendance = document.getElementById('noAttendance');

                        loading.classList.add('hidden');

                        if (attendanceRecords.length === 0) {
                            noAttendance.classList.remove('hidden');
                            return;
                        }

                        container.classList.remove('hidden');
                        container.innerHTML = '';

                        attendanceRecords.forEach(record => {
                            const attendanceCard = document.createElement('div');
                            attendanceCard.className = 'border border-gray-200 rounded-lg p-6 hover:shadow-md transition';
                            attendanceCard.innerHTML = `
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-900 mb-1">${record.event_name}</h3>
                                        <p className="text-sm text-gray-600 mb-2">${new Date(record.event_date).toLocaleDateString()} ‚Ä¢ ${record.venue}</p>
                                        <div className="flex items-center gap-4 text-sm">
                                            <span className="text-gray-500">Check-in Method: ${record.check_in_method}</span>
                                        </div>
                                    </div>
                                    <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                        ‚úÖ Attended
                                    </span>
                                </div>

                                <div className="border-t border-gray-100 pt-4">
                                    <div className="text-sm text-gray-500">
                                        Checked in at ${new Date(record.check_in_time).toString() !== 'Invalid Date' ? new Date(record.check_in_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : record.check_in_time}
                                    </div>
                                </div>
                            `;

                            container.appendChild(attendanceCard);
                        });

                    } else {
                        console.error('Failed to load attendance:', data.error);
                    }
                } catch (error) {
                    console.error('Error loading attendance:', error);
                }
            };

            const handleViewChange = (newView) => {
                setActiveView(newView);
                // Load data when switching to tabs
                if (newView === 'registrations') {
                    loadMyRegistrations();
                } else if (newView === 'attendance') {
                    loadMyAttendance();
                } else if (newView === 'feedback') {
                    loadMyFeedback();
                }
            };

            const renderContent = () => {
                switch (activeView) {
                    case 'proposals':
                        return (
                            <div>
                                <div className="mb-6">
                                    <p className="text-blue-600 text-sm font-medium mb-1">Student Organization Officer</p>
                                    <p className="text-gray-500 text-sm mb-2">
                                        Submit and manage event proposals for your organization
                                    </p>
                                    <h1 className="text-3xl font-bold text-gray-900">Event Proposals</h1>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-semibold text-gray-900">My Event Proposals</h2>
                                        <button
                                            onClick={handleCreateEventProposal}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                            New Event Proposal
                                        </button>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                        <p className="text-blue-900 text-sm">
                                            <strong>üìù Note:</strong> All event proposals require approval from the Admin/OSA before being published to the calendar. You'll receive email notifications about the status of your proposals.
                                        </p>
                                    </div>

                                    {/* Search Bar */}
                                    <div className="mb-4">
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                </svg>
                                            </div>
                                            <input
                                                type="text"
                                                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:border-blue-300 focus:shadow-outline-blue sm:text-sm transition duration-150 ease-in-out"
                                                placeholder="Search proposals by name..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    {/* Status Info */}
                                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                        <button
                                            onClick={() => setFilterStatus('All')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'All'
                                                ? 'bg-gray-800 text-white'
                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                        >
                                            All ({proposals.length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Pending')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Pending'
                                                ? 'bg-yellow-500 text-white shadow-md'
                                                : 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200'
                                                }`}
                                        >
                                            Pending ({proposals.filter(p => p.status === 'Pending').length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Under Review')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Under Review'
                                                ? 'bg-blue-600 text-white shadow-md'
                                                : 'bg-blue-100 text-blue-800 hover:bg-blue-200'
                                                }`}
                                        >
                                            Review ({proposals.filter(p => p.status === 'Under Review').length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Approved')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Approved'
                                                ? 'bg-green-600 text-white shadow-md'
                                                : 'bg-green-100 text-green-800 hover:bg-green-200'
                                                }`}
                                        >
                                            Approved ({proposals.filter(p => p.status === 'Approved').length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Completed')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Completed'
                                                ? 'bg-purple-600 text-white shadow-md'
                                                : 'bg-purple-100 text-purple-800 hover:bg-purple-200'
                                                }`}
                                        >
                                            Completed ({proposals.filter(p => p.status === 'Completed').length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Rejected')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Rejected'
                                                ? 'bg-red-600 text-white shadow-md'
                                                : 'bg-red-100 text-red-800 hover:bg-red-200'
                                                }`}
                                        >
                                            Rejected ({proposals.filter(p => p.status === 'Rejected').length})
                                        </button>
                                        <button
                                            onClick={() => setFilterStatus('Cancelled')}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${filterStatus === 'Cancelled'
                                                ? 'bg-gray-600 text-white shadow-md'
                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                        >
                                            Cancelled ({proposals.filter(p => p.status === 'Cancelled').length})
                                        </button>
                                    </div>

                                    {/* Proposals List */}
                                    {proposalsLoading ? (
                                        <div className="text-center py-12">
                                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                            <p className="text-gray-500">Loading your proposals...</p>
                                        </div>
                                    ) : proposals.length > 0 ? (
                                        <div className="space-y-4">
                                            {proposals
                                                .filter(p => {
                                                    const matchesStatus = filterStatus === 'All' || p.status === filterStatus;
                                                    const matchesSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase());
                                                    return matchesStatus && matchesSearch;
                                                })
                                                .map(proposal => (
                                                    <div key={proposal.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition bg-white">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div>
                                                                <div className="flex items-center gap-2 mb-1">
                                                                    <h3 className="font-semibold text-xl text-gray-900">{proposal.name}</h3>
                                                                    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${proposal.status === 'Approved' ? 'bg-green-100 text-green-800 border-green-200' :
                                                                        proposal.status === 'Pending' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' :
                                                                            proposal.status === 'Rejected' ? 'bg-red-100 text-red-800 border-red-200' :
                                                                                proposal.status === 'Cancelled' ? 'bg-gray-100 text-gray-800 border-gray-200' :
                                                                                    proposal.status === 'Completed' ? 'bg-purple-100 text-purple-800 border-purple-200' :
                                                                                        'bg-blue-100 text-blue-800 border-blue-200'
                                                                        }`}>
                                                                        {proposal.status}
                                                                    </span>
                                                                </div>
                                                                <p className="text-sm text-gray-600">
                                                                    {new Date(proposal.date).toLocaleDateString()} ‚Ä¢ {proposal.venue} ‚Ä¢ {formatTime12Hour(proposal.startTime)} - {formatTime12Hour(proposal.endTime)}
                                                                </p>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-sm font-medium text-gray-900">Budget: ‚Ç±{proposal.budget ? proposal.budget.toLocaleString() : '0'}</div>
                                                                <div className="text-xs text-gray-500">{proposal.attendees} Attendees</div>
                                                            </div>
                                                        </div>

                                                        {proposal.description && (
                                                            <p className="text-sm text-gray-600 mb-4 line-clamp-2">{proposal.description}</p>
                                                        )}

                                                        <div className="flex justify-between items-center border-t border-gray-100 pt-4">
                                                            <div className="text-xs text-gray-500">
                                                                Submitted on {new Date().toLocaleDateString()} {/* Date fallback */}
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button className="text-blue-600 text-sm font-medium hover:text-blue-800">View Details</button>
                                                                {proposal.status === 'Pending' && (
                                                                    <button className="text-red-600 text-sm font-medium hover:text-red-800">Cancel</button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <div className="text-gray-400 mb-4">
                                                <svg className="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                            </div>
                                            <h3 className="text-lg font-medium text-gray-900 mb-2">No Event Proposals Yet</h3>
                                            <p className="text-gray-600 mb-4">Get started by submitting your first event proposal for your organization.</p>
                                            <button
                                                onClick={handleCreateEventProposal}
                                                className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition inline-flex items-center gap-2"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                                Create Event Proposal
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );

                    case 'calendar':
                        return (
                            <div>
                                <div className="mb-6 hidden md:block">
                                    <p className="text-gray-500 text-sm mb-2">
                                        Browse and register for upcoming events
                                    </p>
                                    <h1 className="text-3xl font-bold text-gray-900">Event Calendar</h1>
                                </div>

                                {/* Event Calendar with Month View */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="md:hidden mb-4">
                                        <h2 className="text-xl font-bold text-gray-900 leading-tight">Event Calendar</h2>
                                        <p className="text-xs text-gray-500 mt-1">Browse and register for upcoming events</p>
                                    </div>
                                    <StudentEventCalendar />
                                </div>
                            </div>
                        );

                    case 'resolve-rejection':
                        return (
                            <React.Suspense fallback={<div>Loading...</div>}>
                                <RejectionResolutionPage
                                    eventId={resolvingEventId}
                                    onBack={() => {
                                        window.location.hash = '#/my-events';
                                        setActiveView('proposals'); // Fallback in case hash doesn't trigger
                                    }}
                                    onResolveComplete={() => {
                                        window.location.hash = '#/my-events';
                                        setActiveView('proposals');
                                        if (window.loadMyProposals) window.loadMyProposals();
                                    }}
                                />
                            </React.Suspense>
                        );

                    case 'registrations':
                        return (
                            <div key="registrations-view">
                                <div className="mb-6 hidden md:block">
                                    <p className="text-gray-500 text-sm mb-2">
                                        View and manage your event registrations
                                    </p>
                                    <h1 className="text-3xl font-bold text-gray-900">My Registrations</h1>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-4 md:mb-6 gap-2">
                                        <div className="flex flex-col">
                                            <h2 className="text-lg md:text-xl font-semibold text-gray-900 leading-tight">My Event Registrations</h2>
                                            <p className="text-xs text-gray-500 md:hidden mt-1">View and manage your event registrations</p>
                                        </div>
                                        <button className="bg-blue-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg hover:bg-blue-700 transition text-xs md:text-sm whitespace-nowrap shrink-0">
                                            Browse Events
                                        </button>
                                    </div>

                                    {/* Registration Stats */}
                                    <div className="grid grid-cols-3 gap-2 md:gap-4 mb-6">
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-2 md:p-4 text-center flex flex-col justify-center items-center h-full">
                                            <div className="text-xl md:text-2xl font-bold text-green-600 leading-tight" id="registeredCount">0</div>
                                            <div className="text-xs md:text-sm text-green-800 leading-tight mt-1">Confirmed</div>
                                        </div>
                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2 md:p-4 text-center flex flex-col justify-center items-center h-full">
                                            <div className="text-xl md:text-2xl font-bold text-yellow-600 leading-tight" id="waitlistCount">0</div>
                                            <div className="text-xs md:text-sm text-yellow-800 leading-tight mt-1">Waitlisted</div>
                                        </div>
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-2 md:p-4 text-center flex flex-col justify-center items-center h-full">
                                            <div className="text-xl md:text-2xl font-bold text-blue-600 leading-tight" id="upcomingCount">0</div>
                                            <div className="text-xs md:text-sm text-blue-800 leading-tight mt-1">Upcoming</div>
                                        </div>
                                    </div>

                                    <div id="registrationsLoading" className="flex justify-center items-center py-8">
                                        <div className="flex items-center gap-2 text-gray-600">
                                            <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Loading registrations...
                                        </div>
                                    </div>

                                    <div id="registrationsContainer" className="hidden space-y-4">
                                        {/* Registrations will be loaded here */}
                                    </div>

                                    <div id="noRegistrations" className="hidden text-center py-8">
                                        <div className="text-gray-400 mb-4">
                                            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">No Event Registrations</h3>
                                        <p className="text-gray-600 mb-4">You haven't registered for any events yet.</p>
                                        <button className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                            Browse Available Events
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'attendance':
                        return (
                            <div key="attendance-view">
                                <div className="mb-6 hidden md:block">
                                    <p className="text-gray-500 text-sm mb-2">
                                        Track your attendance across events
                                    </p>
                                    <h1 className="text-3xl font-bold text-gray-900">Attendance History</h1>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="mb-4 md:mb-6">
                                        <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
                                            <div>
                                                <h2 className="text-lg md:text-xl font-semibold text-gray-900 leading-tight">My Attendance Records</h2>
                                                <p className="text-xs md:text-sm text-gray-500 md:text-gray-600 mt-1">
                                                    <span className="md:hidden">Track your attendance across events ‚Ä¢ </span>Real-time tracking via QR codes
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="attendanceLoading" className="flex justify-center items-center py-8">
                                        <div className="flex items-center gap-2 text-gray-600">
                                            <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Loading attendance history...
                                        </div>
                                    </div>

                                    <div id="attendanceContainer" className="hidden space-y-4">
                                        {/* Attendance records will be loaded here */}
                                    </div>

                                    <div id="noAttendance" className="hidden text-center py-8">
                                        <div className="text-gray-400 mb-4">
                                            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">No Attendance Records</h3>
                                        <p className="text-gray-600 mb-4">You haven't checked in to any events yet.</p>
                                        <p className="text-sm text-gray-500">Use your QR codes at event entrances to record attendance.</p>
                                    </div>

                                    <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <p className="text-green-800 text-sm">
                                            <strong>‚úÖ QR Check-in Active:</strong> Your attendance is now tracked in real-time using QR codes at events.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'feedback':
                        return (
                            <div>


                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="mb-6">
                                        <h2 className="text-xl font-semibold text-gray-900 mb-2">Feedback History</h2>
                                        <p className="text-sm text-gray-600">Feedback forms are automatically shown after attending completed events.</p>
                                    </div>

                                    {/* Pending Feedback Section */}
                                    <div id="pendingFeedbackContainer" className="mb-6">
                                        {/* Pending feedback forms will be loaded here */}
                                    </div>

                                    {/* Feedback History */}
                                    <div id="feedbackHistoryContainer">
                                        {/* Feedback history will be loaded here */}
                                    </div>

                                    <div id="noFeedback" className="hidden text-center py-8">
                                        <div className="text-gray-400 mb-4">
                                            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">No Feedback History</h3>
                                        <p className="text-gray-600 mb-4">You haven't submitted feedback for any completed events yet.</p>
                                        <p className="text-sm text-gray-500">Feedback forms will appear automatically after attending events.</p>
                                    </div>
                                </div>
                            </div>
                        );

                    default:
                        return <div>Select a menu item</div>;
                }
            };

            return (
                <>
                    <div className="flex h-screen bg-gray-50">
                        <Sidebar
                            user={user}
                            menuItems={menuItems}
                            activeView={activeView}
                            onViewChange={handleViewChange}
                            onLogout={handleLogout}
                            isOpen={isSidebarOpen}
                            onClose={() => setIsSidebarOpen(false)}
                        />

                        <div className="flex-1 flex flex-col overflow-hidden w-full relative">
                            <header className="bg-white border-b border-gray-200 px-4 md:px-8 py-4 shadow-sm flex-shrink-0">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={() => setIsSidebarOpen(true)}
                                            className="md:hidden text-gray-500 hover:text-gray-700"
                                        >
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                                            </svg>
                                        </button>
                                        <img src="/static/bcp-olp-logo-mini2.png" alt="School Logo" className="h-8 w-auto hidden sm:block" />
                                        <div>
                                            <p className="text-blue-600 text-sm font-medium">School Event Management System</p>
                                            <p className="text-gray-500 text-xs">Student Portal</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <NotificationBell />
                                        <span className="text-sm text-gray-600">{user?.full_name}</span>
                                    </div>
                                </div>
                            </header>

                            <main className="flex-1 overflow-y-auto bg-gray-50 p-8">
                                {renderContent()}
                            </main>
                        </div>
                    </div>

                    {/* Modal Overlay - Same as admin */}
                    {showEventModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-40" onClick={() => setShowEventModal(false)}></div>
                    )}

                    {/* Event Proposal Modal */}
                    {showEventModal && user?.role_name === 'Student Organization Officer' && (
                        <EventFormModal
                            editingId={null}
                            formData={formData}
                            setFormData={setFormData}
                            aiLoading={aiLoading}
                            aiSuggestions={aiSuggestions}
                            budgetData={budgetData}
                            resourceData={resourceData}
                            timelineData={timelineData}
                            activeEquipmentTab={activeEquipmentTab}
                            setActiveEquipmentTab={setActiveEquipmentTab}
                            checkedActivities={checkedActivities}
                            checkedResources={checkedResources}
                            equipmentCategories={equipmentCategories}
                            venueOptions={venueOptions}
                            handleAutoFill={handleAutoFill}
                            handleSaveEvent={handleSaveEvent}
                            setShowModal={setShowEventModal}
                            toggleEquipment={toggleEquipment}
                            toggleActivity={toggleActivity}
                            toggleAdditionalResource={toggleAdditionalResource}
                            setCheckedResources={setCheckedResources}
                            handleBudgetUpdate={handleBudgetUpdate}
                            handleEquipmentUpdate={handleEquipmentUpdate}
                            setAiSuggestions={setAiSuggestions}
                            setBudgetData={setBudgetData}
                            setTimelineData={setTimelineData}
                            modelStatus={modelStatus}
                            budgetEstimate={budgetEstimate}
                            lastAIRequest={lastAIRequest}
                            hasEnoughData={() => formData.name && formData.type && formData.attendees}
                            activeTab="details"
                            onTabChange={() => { }}
                            isConflictRejected={false}
                        />
                    )}

                    {/* Pending Feedback Modal */}
                    {showFeedbackPrompt && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6" role="dialog" aria-modal="true">
                            <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onClick={() => setShowFeedbackPrompt(false)}></div>
                            <div className="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm sm:p-6 z-50">
                                <div>
                                    <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100">
                                        <svg className="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                                        </svg>
                                    </div>
                                    <div className="mt-3 text-center sm:mt-5">
                                        <h3 className="text-base font-semibold leading-6 text-gray-900" id="modal-title">Event Feedback Available</h3>
                                        <div className="mt-2">
                                            <p className="text-sm text-gray-500">
                                                You have <strong>{pendingFeedbackCount}</strong> {pendingFeedbackCount === 1 ? 'event' : 'events'} waiting for your feedback. Your input helps us improve future events!
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-5 sm:mt-6 space-y-2">
                                    <button
                                        type="button"
                                        className="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600"
                                        onClick={() => {
                                            setShowFeedbackPrompt(false);
                                            handleViewChange('feedback');
                                        }}
                                    >
                                        Give Feedback Now
                                    </button>
                                    <button
                                        type="button"
                                        className="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                                        onClick={() => setShowFeedbackPrompt(false)}
                                    >
                                        Maybe Later
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        // Authentication check
        checkAuth();

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudentDashboard />);
    </script>
</body>

</html>