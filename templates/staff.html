<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - School Event Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body,
        #root {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Authentication utilities -->
    <script src="/static/js/auth.js"></script>

    <!-- QR Code Scanning Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script type="text/babel" src="/static/js/components/Sidebar.js"></script>
    <script type="text/babel" src="/static/js/components/QRScanner.js"></script>
    <script type="text/babel" src="/static/js/pages/StaffEquipmentApprovals.js?v=2.5"></script>

    <!-- Main Dashboard Script -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Sidebar = window.Sidebar;
        const EquipmentApprovals = window.EquipmentApprovals;

        function StaffDashboard() {
            const [user, setUser] = useState(null);
            const [activeView, setActiveView] = useState('scanner');
            const [selectedEventId, setSelectedEventId] = useState(null);
            const [events, setEvents] = useState([]);
            const [loadingEvents, setLoadingEvents] = useState(true);

            useEffect(() => {
                const userJson = localStorage.getItem('user');
                if (userJson) {
                    setUser(JSON.parse(userJson));
                }
            }, []);

            const handleLogout = async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    localStorage.removeItem('user');
                    window.location.href = '/';
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            };

            useEffect(() => {
                if (activeView === 'scanner') {
                    loadEvents();
                }
            }, [activeView]);

            const loadEvents = async () => {
                try {
                    const res = await fetch('/api/events?status=Approved', { credentials: 'include' });
                    const data = await res.json();
                    if (data.success) {
                        setEvents(data.events || []);
                    }
                } catch (error) {
                    console.error('Error loading events:', error);
                } finally {
                    setLoadingEvents(false);
                }
            };

            const menuItems = [
                {
                    id: 'scanner',
                    label: 'QR Attendance Scanner',
                    icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 15h4.01M12 21h4.01M8 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M8 12h4.01M8 15h4.01M8 21h4.01" /></svg>
                },
                {
                    id: 'approvals',
                    label: 'Resource Approvals',
                    icon: <svg className="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                },
            ];

            return (
                <div className="flex h-screen bg-gray-50">
                    <Sidebar
                        user={user}
                        menuItems={menuItems}
                        activeView={activeView}
                        onViewChange={setActiveView}
                        onLogout={handleLogout}
                    />

                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b border-gray-200 px-8 py-4 shadow-sm">
                            <p className="text-blue-600 text-sm font-medium mb-1">Staff Portal</p>
                            <p className="text-gray-500 text-sm mb-2">
                                {activeView === 'scanner' ? 'Scan QR codes for attendance check-in' : activeView === 'approvals' ? 'Review and approve venue & equipment requests for upcoming events' : 'Manage your staff operations'}
                            </p>
                            <h1 className="text-3xl font-bold text-gray-900">
                                {activeView === 'scanner' ? 'QR Attendance Scanner' : activeView === 'approvals' ? 'Resource Approvals' : 'Dashboard'}
                            </h1>
                        </header>

                        <main className="flex-1 overflow-y-auto bg-gray-50 p-8">
                            {activeView === 'scanner' && (
                                <div>
                                    {!selectedEventId ? (
                                        <div className="bg-white rounded-lg shadow p-6">
                                            <h2 className="text-xl font-semibold text-gray-900 mb-4">Select Event for Attendance</h2>
                                            <p className="text-gray-600 mb-6">Choose an event to start scanning QR codes for attendance check-in.</p>

                                            {/* Camera Requirements Notice */}
                                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                                <h4 className="font-semibold text-yellow-900 mb-2">üì∑ Camera Requirements</h4>
                                                <ul className="text-sm text-yellow-800 space-y-1">
                                                    <li>‚Ä¢ Camera access is required for QR scanning</li>
                                                    <li>‚Ä¢ Allow camera permissions when prompted</li>
                                                    <li>‚Ä¢ Use HTTPS connection for camera access</li>
                                                    <li>‚Ä¢ Use Manual Check-in as backup if camera fails</li>
                                                </ul>
                                            </div>

                                            {/* Event Selection */}
                                            <div className="grid gap-4">
                                                {loadingEvents ? (
                                                    <div className="text-center py-8 text-gray-500">Loading events...</div>
                                                ) : events.length === 0 ? (
                                                    <div className="text-center py-8 text-gray-500">No approved events available for attendance tracking.</div>
                                                ) : (
                                                    events.map(event => {
                                                        const eventStart = new Date(`${event.date}T${event.startTime || '00:00'}`);
                                                        const now = new Date();
                                                        const isUpcoming = eventStart > now;

                                                        return (
                                                            <div key={event.id}
                                                                className={`border border-gray-200 rounded-lg p-4 transition ${isUpcoming ? 'opacity-75 bg-gray-50 cursor-not-allowed' : 'hover:border-blue-300 cursor-pointer bg-white'}`}
                                                                onClick={() => !isUpcoming && setSelectedEventId(event.id)}>
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <h3 className="font-semibold text-gray-900">{event.name}</h3>
                                                                        <p className="text-sm text-gray-600">
                                                                            {new Date(event.date).toLocaleDateString()} ‚Ä¢ {event.venue}
                                                                        </p>
                                                                        <p className="text-xs text-gray-500 mt-1">
                                                                            Status: {event.approval_status || event.status} ‚Ä¢ Expected: {event.attendees || event.expected_attendees || 'N/A'}
                                                                        </p>
                                                                    </div>
                                                                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${isUpcoming ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                                                        {isUpcoming ? 'Upcoming' : 'Available'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <button
                                                onClick={() => setSelectedEventId(null)}
                                                className="mb-4 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                                            >
                                                ‚Üê Back to Event Selection
                                            </button>
                                            <QRScanner eventId={selectedEventId} />
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeView === 'approvals' && <EquipmentApprovals />}
                        </main>
                    </div>
                </div>
            );
        }

        // Authentication check
        checkAuth();

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StaffDashboard />);
    </script>
</body>

</html>